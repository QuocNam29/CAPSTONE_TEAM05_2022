@model IEnumerable<CAP_TEAM05_2022.Models.cart>
@{
    Layout = null;
    int no = 0;
    float total = Model.Sum(s => s.price);
}
@if (Model.Count() >= 1)
{
    <div class="row" id="myDIV">
        <div class="col-md-2">
            <div class="form-group">
                <label>Tạm tính tiền</label>
                <input type="text" id="cart_total" class="form-control" value="@total.ToString("N0")" disabled>
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label>VAT(%)</label>
                <input type="number" id="cart_vat" min="0" max="100" value="0" class="form-control">
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label>Chiết khấu(%)</label>
                <input type="number" id="cart_discount" min="0" max="100" value="0" class="form-control">
            </div>
        </div>
        <div class="col-md-2">
            <div class="form-group">
                <label>Thành tiền</label>
                <input type="text" id="total" disabled="disabled" class="form-control" value="@total.ToString("N0")">
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label>Trả trước</label>                
                <input type="text" placeholder="Thanh toán 1 phần" id="cart_Prepay" max="999999999999" class="form-control"
                       pattern="[0-9.,]+" data-type="number" name="purchase_price" onchange="ButtonDebit()">
            </div>
        </div>
        <div class="col-md-12">
            <div class="form-group">
                <label>Ghi chú</label>
                <input type="text" id="cart_note" placeholder="Ghi chú" class="form-control">
            </div>
        </div>
    </div>
}

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body table-border-style">
                <div class="table-responsive">
                    <table id="example" class="table table-hover">
                        <thead>
                            <tr>
                                <th class="text-center">STT</th>
                                <th>Mã sản phẩm</th>
                                <th>Tên sản phẩm</th>
                                <th class="text-center">Đơn vị</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-center">Giá bán</th>
                                <th class="text-center">Chiết khấu</th>
                                <th class="text-center">Thành tiền</th>
                                <th>Ghi chú</th>
                                <th>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                no++;
                                <tr>
                                    <td>@no </td>
                                    <td>@item.product.code</td>
                                    <td>@item.product.name</td>
                                    <td>@item.product.unit</td>
                                    <td>@item.quantity</td>
                                    <td>@item.product.sell_price.ToString("N0")</td>
                                    <td>@item.discount</td>
                                    <td>@item.price.ToString("N0")</td>
                                    <td>@item.note</td>
                                    <td>
                                        <button class="btn btn-success">
                                            <i class="feather icon-edit">
                                            </i>
                                        </button>
                                        <input hidden type="text" id="URLDelete" value="@Url.Action("Delete_CartProduct", "carts")">
                                        <button class="btn btn-danger" onclick="deleteAlert('@item.id')" id="Delete">
                                            <i class="feather icon-trash-2">
                                            </i>
                                        </button>
                                        
                                    </td>


                                </tr>
                            }

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="Edit_Modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="Edit_ModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <form class="needs-validation" method="post" @*action="@Url.Action("Edit_Category", "categories")"*@ novalidate>
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h5 class="modal-title" id="Edit_ModalLabel">Chỉnh sửa danh mục</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>
                                    Tên danh mục<span class="text-danger">*</span>
                                </label>
                                <div class="position-relative">
                                    <input hidden id="edit_id" name="category_id" />
                                    <input type="text" placeholder="Nhập tên danh mục" id="Edit_name" class="form-control" name="name_category" pattern="\S+.*" required>
                                    <div class="invalid-feedback">
                                        Vui lòng nhập tên danh mục !
                                    </div>
                                </div> <!---->
                            </div>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn  btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="submit_edit" @*onclick="Update()"*@>Chỉnh sửa</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        $('#example').DataTable({
            pagingType: 'full_numbers',
        });
    });
    $("#cart_vat").change(function () {
        console.log(Number($('#cart_vat').val()));
        var total = Number($('#cart_total').val().replace(/\,/g, '').replace(/\./g, '')) * (1 + Number($('#cart_vat').val()) / 100) * (1 - (Number($('#cart_discount').val()) / 100));
        $('#total').val(total.toLocaleString());
    });
    $("#cart_discount").change(function () {
        var total = Number($('#cart_total').val().replace(/\,/g, '').replace(/\./g, '')) * (1 + Number($('#cart_vat').val()) / 100) * (1 - (Number($('#cart_discount').val()) / 100));
        $('#total').val(total.toLocaleString());
    });
    $('#cart_Prepay').keydown(function (e) {
        setTimeout(() => {
            let parts = $(this).val().split(".");
            let v = parts[0].replace(/\D/g, ""),
                dec = parts[1]
            let calc_num = Number((dec !== undefined ? v + "." + dec : v));
            // use this for numeric calculations
            // console.log('number for calculations: ', calc_num);
            let n = new Intl.NumberFormat('en-EN').format(v);
            n = dec !== undefined ? n + "." + dec : n;
            $(this).val(n);
        })
    })
</script>
<script>
    function deleteAlert(id) {
        swal({
            title: "Bạn chắn chắn muốn xóa ?",
            type: "warning",
            showCancelButton: true,
            closeOnConfirm: false,
            confirmButtonText: "Xác nhận",
            confirmButtonColor: "#ec6c62",
        },
            function () {
                var categorys = {};
                categorys.id = id;

                $.ajax({
                    url: '@Url.Action("Delete_CartProduct", "carts")',
                    data: JSON.stringify(categorys),
                    type: "POST",
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json'
                })
                    .done(function (data) {
                        GetList_Cart($('#customer_id').val());
                        sweetAlert
                            ({
                                title: "Đã xóa!",
                                type: "success"
                            },)
                    })
                
            })
    }

</script>